# –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è SQL –∑–∞–ø–∏—Ç—ñ–≤

## –ó–º—ñ—Å—Ç

1. [–ó–∞–≤–¥–∞–Ω–Ω—è 1: –ö–æ–º–ø–ª–µ–∫—Å–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è](#–∑–∞–≤–¥–∞–Ω–Ω—è-1-–∫–æ–º–ø–ª–µ–∫—Å–Ω–µ-—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è)
2. [–ó–∞–≤–¥–∞–Ω–Ω—è 2: –ë–µ–∑–ø–µ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è](#–∑–∞–≤–¥–∞–Ω–Ω—è-2-–±–µ–∑–ø–µ—á–Ω–µ-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è)
3. [–ó–∞–≤–¥–∞–Ω–Ω—è 3: –ö–∞—Å–∫–∞–¥–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è](#–∑–∞–≤–¥–∞–Ω–Ω—è-3-–∫–∞—Å–∫–∞–¥–Ω–µ-–≤–∏–¥–∞–ª–µ–Ω–Ω—è)
4. [–ó–∞–≤–¥–∞–Ω–Ω—è 4: –ü—Ä–æ—Å—Ç—ñ SELECT](#–∑–∞–≤–¥–∞–Ω–Ω—è-4-–ø—Ä–æ—Å—Ç—ñ-select)
5. [–ó–∞–≤–¥–∞–Ω–Ω—è 5: –°–∫–ª–∞–¥–Ω—ñ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏](#–∑–∞–≤–¥–∞–Ω–Ω—è-5-—Å–∫–ª–∞–¥–Ω—ñ-–∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ-–∑–∞–ø–∏—Ç–∏)

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 1: –ö–æ–º–ø–ª–µ–∫—Å–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

### –ë—ñ–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞

–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ü—ñ–Ω—é—î –∫–Ω–∏–≥—É, –≤—ñ–Ω –∑–∞–∑–≤–∏—á–∞–π –∑–∞–ª–∏—à–∞—î —è–∫ —á–∏—Å–ª–æ–≤—É –æ—Ü—ñ–Ω–∫—É (1-5 –∑—ñ—Ä–æ–∫), —Ç–∞–∫ —ñ —Ç–µ–∫—Å—Ç–æ–≤–∏–π –≤—ñ–¥–≥—É–∫. –¶—ñ –¥–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –º–∞—é—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ - –∞–±–æ –æ–±–∏–¥–≤—ñ —É—Å–ø—ñ—à–Ω–æ, –∞–±–æ –∂–æ–¥–Ω–∞.

### Endpoint

```
POST /api/reviews/full
```

### –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É

```json
{
  "userId": 1,
  "bookId": 1,
  "score": 4.5,
  "reviewText": "–ß—É–¥–æ–≤–∞ –∫–Ω–∏–≥–∞! –î—É–∂–µ —Å–ø–æ–¥–æ–±–∞–ª–∞—Å—å —Å—é–∂–µ—Ç–Ω–∞ –ª—ñ–Ω—ñ—è —Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤."
}
```

### SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó

#### 1. –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

```sql
SELECT * FROM users
WHERE userid = $1;
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

- –ß–∏ —ñ—Å–Ω—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º ID
- –ß–∏ –Ω–µ –≤–∏–¥–∞–ª–µ–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (`deletedAt IS NULL`)

#### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—É

```sql
SELECT * FROM rating
WHERE userid = $1 AND bookid = $2;
```

**–õ–æ–≥—ñ–∫–∞:**

- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –æ—Ü—ñ–Ω–∏—Ç–∏ –∫–Ω–∏–≥—É —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
- –Ø–∫—â–æ –∑–∞–ø–∏—Å —ñ—Å–Ω—É—î —ñ `deletedAt IS NULL` ‚Üí –ø–æ–º–∏–ª–∫–∞ 409 Conflict
- –Ø–∫—â–æ –∑–∞–ø–∏—Å —ñ—Å–Ω—É—î –∞–ª–µ `deletedAt IS NOT NULL` ‚Üí –¥–æ–∑–≤–æ–ª—è—î–º–æ (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–¥–∞–ª–∏–≤ —Å—Ç–∞—Ä—É –æ—Ü—ñ–Ω–∫—É)

#### 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É

```sql
INSERT INTO rating (userid, bookid, score, updatedat)
VALUES ($1, $2, $3, NOW())
RETURNING *;
```

**–ü–æ–ª—è:**

- `ratingid` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è (SERIAL)
- `userid` - –∑ –∑–∞–ø–∏—Ç—É
- `bookid` - –∑ –∑–∞–ø–∏—Ç—É
- `score` - –∑ –∑–∞–ø–∏—Ç—É (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è: 1.0-5.0)
- `updatedat` - –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å
- `deletedat` - NULL –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

#### 4. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É

```sql
INSERT INTO review (userid, bookid, reviewtext, reviewdate)
VALUES ($1, $2, $3, NOW())
RETURNING *;
```

**–ü–æ–ª—è:**

- `reviewid` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è (SERIAL)
- `userid` - –∑ –∑–∞–ø–∏—Ç—É
- `bookid` - –∑ –∑–∞–ø–∏—Ç—É
- `reviewtext` - –∑ –∑–∞–ø–∏—Ç—É (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è: 10-5000 —Å–∏–º–≤–æ–ª—ñ–≤)
- `reviewdate` - –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å
- `deletedat` - NULL –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

### –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω—ñ—Å—Ç—å

–í—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó:

```sql
BEGIN;
  -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  SELECT * FROM users WHERE userid = $1;

  -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—É
  SELECT * FROM rating WHERE userid = $1 AND bookid = $2;

  -- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—É
  INSERT INTO rating (...) VALUES (...);

  -- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É
  INSERT INTO review (...) VALUES (...);
COMMIT;
```

**–£ –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏:**

```sql
ROLLBACK;
```

### –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

| –ü–æ–º–∏–ª–∫–∞                 | HTTP –∫–æ–¥ | –û–ø–∏—Å                             |
| ----------------------- | -------- | -------------------------------- |
| –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π | 404      | `userId` –Ω–µ —ñ—Å–Ω—É—î –≤ –ë–î           |
| –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∏–¥–∞–ª–µ–Ω–∏–π    | 403      | `deletedAt IS NOT NULL`          |
| –î—É–±–ª—ñ–∫–∞—Ç –æ—Ü—ñ–Ω–∫–∏         | 409      | –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ –æ—Ü—ñ–Ω–∏–≤ —Ü—é –∫–Ω–∏–≥—É   |
| –ù–µ–≤–∞–ª—ñ–¥–Ω–∞ –æ—Ü—ñ–Ω–∫–∞        | 400      | `score < 1.0` –∞–±–æ `score > 5.0`  |
| –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π —Ç–µ–∫—Å—Ç        | 400      | –î–æ–≤–∂–∏–Ω–∞ < 10 –∞–±–æ > 5000 —Å–∏–º–≤–æ–ª—ñ–≤ |

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 2: –ë–µ–∑–ø–µ—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

### –ë—ñ–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞

–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω—é—î —Å–≤–æ—é –æ—Ü—ñ–Ω–∫—É –∫–Ω–∏–≥–∏, –º–æ–∂–µ –≤–∏–Ω–∏–∫–Ω—É—Ç–∏ **race condition**: –¥–≤–∞ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞–º–∞–≥–∞—é—Ç—å—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —Ç—É —Å–∞–º—É –æ—Ü—ñ–Ω–∫—É. –ü–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –≤—Ç—Ä–∞—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω—å.

### –ü—Ä–æ–±–ª–µ–º–∞: Lost Update

**–°—Ü–µ–Ω–∞—Ä—ñ–π:**

1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Å—Ç–æ—Ä—ñ–Ω–∫—É (–æ—Ü—ñ–Ω–∫–∞ = 3.0, timestamp = T1)
2. –Ü–Ω—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á (–∞–±–æ —Ç–∞ –∂ –ª—é–¥–∏–Ω–∞ –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ) –∑–º—ñ–Ω—é—î –æ—Ü—ñ–Ω–∫—É –Ω–∞ 5.0 (timestamp = T2)
3. –ü–µ—Ä—à–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–º—ñ–Ω—é—î –æ—Ü—ñ–Ω–∫—É –Ω–∞ 4.0 (–∑ timestamp = T1)
4. –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—Ü—ñ–Ω–∫–∞ 5.0 –≤—Ç—Ä–∞—á–µ–Ω–∞! üò±

### –†—ñ—à–µ–Ω–Ω—è: –û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è

–ö–ª—ñ—î–Ω—Ç –Ω–∞–¥—Å–∏–ª–∞—î `lastUpdatedAt` –∑ –º–æ–º–µ–Ω—Ç—É —á–∏—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö. –°–µ—Ä–≤–µ—Ä –ø–æ—Ä—ñ–≤–Ω—é—î –∑ –ø–æ—Ç–æ—á–Ω–∏–º `updatedAt` –≤ –ë–î.

### Endpoint

```
PUT /api/ratings/:id/safe
```

### –ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É

```json
{
  "score": 5.0,
  "lastUpdatedAt": "2024-12-17T12:30:45.123Z"
}
```

### SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó

#### 1. –ß–∏—Ç–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É

```sql
SELECT ratingid, userid, bookid, score, updatedat, deletedat
FROM rating
WHERE ratingid = $1;
```

**–©–æ –æ—Ç—Ä–∏–º—É—î–º–æ:**

- –ü–æ—Ç–æ—á–Ω–∞ –æ—Ü—ñ–Ω–∫–∞
- –ü–æ—Ç–æ—á–Ω–∏–π `updatedAt` timestamp
- –°—Ç–∞—Ç—É—Å –≤–∏–¥–∞–ª–µ–Ω–Ω—è

#### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ timestamp

```javascript
const dbTime = new Date(current.updatedAt).getTime();
const clientTime = new Date(lastUpdatedAt).getTime();

if (dbTime !== clientTime) {
  throw new Error("CONFLICT"); // 409 Conflict
}
```

**–õ–æ–≥—ñ–∫–∞:**

- –Ø–∫—â–æ `dbTime === clientTime` ‚Üí –¥–∞–Ω—ñ –Ω–µ –∑–º—ñ–Ω—é–≤–∞–ª–∏—Å—å, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑–ø–µ—á–Ω–µ
- –Ø–∫—â–æ `dbTime !== clientTime` ‚Üí —Ö—Ç–æ—Å—å –≤–∂–µ –æ–Ω–æ–≤–∏–≤, –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –≤–µ—Ä—Å—ñ–π

#### 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è (—è–∫—â–æ timestamp –∑–±—ñ–≥–∞—î—Ç—å—Å—è)

```sql
UPDATE rating
SET
  score = $1,
  updatedat = NOW()
WHERE ratingid = $2
RETURNING *;
```

**–©–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è:**

- `score` - –Ω–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞
- `updatedat` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –¥–æ NOW()

### –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è

```sql
BEGIN;
  -- –ß–∏—Ç–∞–Ω–Ω—è + –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞
  SELECT * FROM rating WHERE ratingid = $1 FOR UPDATE;

  -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ timestamp (–≤ –∫–æ–¥—ñ)

  -- –û–Ω–æ–≤–ª–µ–Ω–Ω—è
  UPDATE rating SET score = $2, updatedat = NOW() WHERE ratingid = $1;
COMMIT;
```

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** `FOR UPDATE` –±–ª–æ–∫—É—î —Ä—è–¥–æ–∫ –¥–ª—è —ñ–Ω—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó.

### –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

| –ü–æ–º–∏–ª–∫–∞             | HTTP –∫–æ–¥ | –û–ø–∏—Å                                       |
| ------------------- | -------- | ------------------------------------------ |
| –†–µ–π—Ç–∏–Ω–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ | 404      | `ratingId` –Ω–µ —ñ—Å–Ω—É—î                        |
| –†–µ–π—Ç–∏–Ω–≥ –≤–∏–¥–∞–ª–µ–Ω–æ    | 410      | `deletedAt IS NOT NULL`                    |
| –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –≤–µ—Ä—Å—ñ–π     | 409      | Timestamp –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è (—Ö—Ç–æ—Å—å –≤–∂–µ –æ–Ω–æ–≤–∏–≤) |
| –ù–µ–≤–∞–ª—ñ–¥–Ω–∞ –æ—Ü—ñ–Ω–∫–∞    | 400      | `score < 1.0` –∞–±–æ `score > 5.0`            |

### –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏

**–£—Å–ø—ñ—à–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:**

```
1. –ö–ª—ñ—î–Ω—Ç —á–∏—Ç–∞—î: score=3.0, updatedAt="2024-12-17T12:00:00Z"
2. –ö–ª—ñ—î–Ω—Ç –Ω–∞–¥—Å–∏–ª–∞—î: score=5.0, lastUpdatedAt="2024-12-17T12:00:00Z"
3. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î: DB updatedAt === lastUpdatedAt ‚úÖ
4. –°–µ—Ä–≤–µ—Ä –æ–Ω–æ–≤–ª—é—î: score=5.0, updatedAt=NOW()
5. –í—ñ–¥–ø–æ–≤—ñ–¥—å: 200 OK
```

**–ö–æ–Ω—Ñ–ª—ñ–∫—Ç:**

```
1. –ö–ª—ñ—î–Ω—Ç –ê —á–∏—Ç–∞—î: score=3.0, updatedAt="T1"
2. –ö–ª—ñ—î–Ω—Ç –ë –æ–Ω–æ–≤–ª—é—î: score=5.0 (updatedAt —Å—Ç–∞—î "T2")
3. –ö–ª—ñ—î–Ω—Ç –ê –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –∑ lastUpdatedAt="T1"
4. –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î: DB updatedAt("T2") !== lastUpdatedAt("T1") ‚ùå
5. –í—ñ–¥–ø–æ–≤—ñ–¥—å: 409 Conflict "–î–∞–Ω—ñ –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É."
```

### –©–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è

‚úÖ **–û–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è:**

- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è timestamp –¥–ª—è –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è
- –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è lost updates –±–µ–∑ –ø–µ—Å–∏–º—ñ—Å—Ç–∏—á–Ω–∏—Ö –ª–æ–∫—ñ–≤

‚úÖ **Race condition handling:**

- –ë–µ–∑–ø–µ—á–Ω–µ –æ–¥–Ω–æ—á–∞—Å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç

‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å:**

- –ß–∏—Ç–∞–Ω–Ω—è + –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –æ–¥–Ω—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
- Atomic compare-and-swap

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 3: –ö–∞—Å–∫–∞–¥–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

### –ë—ñ–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞

–ü—Ä–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ç–∞–∫–æ–∂ "–≤–∏–¥–∞–ª–∏—Ç–∏" –≤—Å—ñ –π–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∏ —Ç–∞ –≤—ñ–¥–≥—É–∫–∏, –∞–ª–µ –∑–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.

### –ß–æ–º—É Soft Delete?

**–ü–µ—Ä–µ–≤–∞–≥–∏:**

- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –∑–≤—ñ—Ç—ñ–≤
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
- –¶—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–Ω–∏–≥–∏ –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è —Ä–∞–ø—Ç–æ–≤–æ)

**–ù–µ–¥–æ–ª—ñ–∫–∏:**

- –ë—ñ–ª—å—à–µ –º—ñ—Å—Ü—è –≤ –ë–î
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —É –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç–∞—Ö

### Endpoint

```
DELETE /api/users/:id/deactivate
```

### SQL –æ–ø–µ—Ä–∞—Ü—ñ—ó

#### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

```sql
SELECT userid, username, email, deletedat
FROM users
WHERE userid = $1;
```

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

- –ß–∏ —ñ—Å–Ω—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
- –ß–∏ –Ω–µ –≤–∏–¥–∞–ª–µ–Ω–∏–π –≤–∂–µ (`deletedAt IS NULL`)

#### 2. –ú'—è–∫–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤

```sql
UPDATE rating
SET deletedat = NOW()
WHERE userid = $1 AND deletedat IS NULL;
```

**–õ–æ–≥—ñ–∫–∞:**

- –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ `deletedAt` = –ø–æ—Ç–æ—á–Ω–∏–π —á–∞—Å
- –û–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –∑–∞–ø–∏—Å–∏ (`deletedAt IS NULL`)
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ 0 (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤)

#### 3. –ú'—è–∫–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤

```sql
UPDATE review
SET deletedat = NOW()
WHERE userid = $1 AND deletedat IS NULL;
```

**–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ —Ä–µ–π—Ç–∏–Ω–≥–∞–º.**

#### 4. –ú'—è–∫–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

```sql
UPDATE users
SET deletedat = NOW()
WHERE userid = $1;
```

### –ü–æ–≤–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è

```sql
BEGIN;
  -- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
  SELECT * FROM users WHERE userid = $1;

  -- –í–∏–¥–∞–ª–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤
  UPDATE rating SET deletedat = NOW()
  WHERE userid = $1 AND deletedat IS NULL;

  -- –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤
  UPDATE review SET deletedat = NOW()
  WHERE userid = $1 AND deletedat IS NULL;

  -- –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  UPDATE users SET deletedat = NOW()
  WHERE userid = $1;
COMMIT;
```

**–ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–ª–∏–≤–∏–π:**

1. –°–ø–æ—á–∞—Ç–∫—É –¥–æ—á—ñ—Ä–Ω—ñ –∑–∞–ø–∏—Å–∏ (ratings, reviews)
2. –ü–æ—Ç—ñ–º –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–∏–π –∑–∞–ø–∏—Å (users)

### –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤

–£ –≤—Å—ñ—Ö SELECT –∑–∞–ø–∏—Ç–∞—Ö –ø–æ—Ç—Ä—ñ–±–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏:

```sql
-- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
SELECT * FROM rating
WHERE userid = $1 AND deletedat IS NULL;

-- –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
SELECT * FROM users
WHERE deletedat IS NULL;

-- –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–Ω–∏–≥–∏ (—Ç—ñ–ª—å–∫–∏ –∞–∫—Ç–∏–≤–Ω—ñ –æ—Ü—ñ–Ω–∫–∏)
SELECT AVG(score) FROM rating
WHERE bookid = $1 AND deletedat IS NULL;
```

### –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

| –ü–æ–º–∏–ª–∫–∞                 | HTTP –∫–æ–¥ | –û–ø–∏—Å                    |
| ----------------------- | -------- | ----------------------- |
| –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π | 404      | `userId` –Ω–µ —ñ—Å–Ω—É—î –≤ –ë–î  |
| –í–∂–µ –≤–∏–¥–∞–ª–µ–Ω–æ            | 410      | `deletedAt IS NOT NULL` |

### –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π endpoint:

```sql
BEGIN;
  -- –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  UPDATE users SET deletedat = NULL WHERE userid = $1;

  -- –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤
  UPDATE rating SET deletedat = NULL WHERE userid = $1;

  -- –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤
  UPDATE review SET deletedat = NULL WHERE userid = $1;
COMMIT;
```

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 4: –ü—Ä–æ—Å—Ç—ñ SELECT

### 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤ –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é

**Endpoint:** `GET /api/ratings`

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**

- `userId` - —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
- `bookId` - —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –∫–Ω–∏–≥–æ—é
- `minScore` - –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞

#### –ü—Ä–∏–∫–ª–∞–¥ 1: –í—Å—ñ —Ä–µ–π—Ç–∏–Ω–≥–∏

```sql
SELECT
  r.ratingid,
  r.userid,
  r.bookid,
  r.score,
  r.updatedat,
  u.username,
  b.title
FROM rating r
INNER JOIN users u ON r.userid = u.userid
INNER JOIN book b ON r.bookid = b.bookid
WHERE r.deletedat IS NULL
ORDER BY r.updatedat DESC;
```

**–©–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î:**

- JOIN –¥–≤–æ—Ö —Ç–∞–±–ª–∏—Ü—å
- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
- –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –¥–∞—Ç–æ—é

#### –ü—Ä–∏–∫–ª–∞–¥ 2: –†–µ–π—Ç–∏–Ω–≥–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

```sql
SELECT
  r.ratingid,
  r.score,
  r.updatedat,
  b.title,
  b.isbn
FROM rating r
INNER JOIN book b ON r.bookid = b.bookid
WHERE r.userid = $1
  AND r.deletedat IS NULL
ORDER BY r.updatedat DESC;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**

- `$1` - userId –∑ query string

#### –ü—Ä–∏–∫–ª–∞–¥ 3: –í–∏—Å–æ–∫—ñ –æ—Ü—ñ–Ω–∫–∏ –∫–Ω–∏–≥–∏

```sql
SELECT
  r.ratingid,
  r.score,
  u.username,
  u.nickname
FROM rating r
INNER JOIN users u ON r.userid = u.userid
WHERE r.bookid = $1
  AND r.score >= $2
  AND r.deletedat IS NULL
ORDER BY r.score DESC;
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**

- `$1` - bookId
- `$2` - minScore (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 4.0)

### 2. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –¥–∞–Ω–∏–º–∏

**Endpoint:** `GET /api/users/:id`

```sql
SELECT
  u.userid,
  u.username,
  u.email,
  u.nickname,
  u.createdat,

  -- –†–µ–π—Ç–∏–Ω–≥–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  json_agg(DISTINCT jsonb_build_object(
    'ratingId', r.ratingid,
    'bookId', r.bookid,
    'bookTitle', rb.title,
    'score', r.score,
    'updatedAt', r.updatedat
  )) FILTER (WHERE r.ratingid IS NOT NULL) as ratings,

  -- –í—ñ–¥–≥—É–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  json_agg(DISTINCT jsonb_build_object(
    'reviewId', rv.reviewid,
    'bookId', rv.bookid,
    'bookTitle', rvb.title,
    'text', rv.reviewtext,
    'date', rv.reviewdate
  )) FILTER (WHERE rv.reviewid IS NOT NULL) as reviews

FROM users u
LEFT JOIN rating r ON u.userid = r.userid AND r.deletedat IS NULL
LEFT JOIN book rb ON r.bookid = rb.bookid
LEFT JOIN review rv ON u.userid = rv.userid AND rv.deletedat IS NULL
LEFT JOIN book rvb ON rv.bookid = rvb.bookid

WHERE u.userid = $1
GROUP BY u.userid;
```

**–©–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î:**

- –ú–Ω–æ–∂–∏–Ω–Ω—ñ LEFT JOIN
- –ê–≥—Ä–µ–≥–∞—Ü—ñ—è –∑ `json_agg()`
- GROUP BY –¥–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è —Ä—è–¥–∫—ñ–≤
- FILTER –¥–ª—è —É–º–æ–≤–Ω–æ—ó –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó

### –©–æ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ó–∞–≤–¥–∞–Ω–Ω—è 4

‚úÖ **–ë–∞–∑–æ–≤—ñ SELECT –æ–ø–µ—Ä–∞—Ü—ñ—ó:**

- WHERE —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
- JOIN —Ç–∞–±–ª–∏—Ü—å
- ORDER BY —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è

‚úÖ **–ü–∞–≥—ñ–Ω–∞—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):**

```sql
LIMIT $1 OFFSET $2
```

‚úÖ **–í–∫–ª—é—á–µ–Ω–Ω—è –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö:**

- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è JOIN –∑–∞–º—ñ—Å—Ç—å N+1 –∑–∞–ø–∏—Ç—ñ–≤
- –ï—Ñ–µ–∫—Ç–∏–≤–Ω–µ —á–∏—Ç–∞–Ω–Ω—è

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 5: –°–∫–ª–∞–¥–Ω—ñ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏

### 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

**–ë—ñ–∑–Ω–µ—Å-–ø–∏—Ç–∞–Ω–Ω—è:**
_"–Ø–∫—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –Ω–∞–π–±—ñ–ª—å—à –∞–∫—Ç–∏–≤–Ω—ñ? –°–∫—ñ–ª—å–∫–∏ –∫–Ω–∏–≥ –≤–æ–Ω–∏ –æ—Ü—ñ–Ω–∏–ª–∏? –Ø–∫–∏–π —ó—Ö–Ω—ñ–π —Å–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª?"_

**Endpoint:** `GET /api/analytics/user-activity`

```sql
WITH user_ratings AS (
  -- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤ –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  SELECT
    u.userid,
    u.username,
    u.email,
    COUNT(DISTINCT r.ratingid) as rating_count,
    AVG(r.score) as avg_score
  FROM users u
  LEFT JOIN rating r
    ON u.userid = r.userid
    AND r.deletedat IS NULL
  WHERE u.deletedat IS NULL
  GROUP BY u.userid, u.username, u.email
),
user_reviews AS (
  -- –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥–≥—É–∫—ñ–≤ –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  SELECT
    u.userid,
    COUNT(DISTINCT rv.reviewid) as review_count
  FROM users u
  LEFT JOIN review rv
    ON u.userid = rv.userid
    AND rv.deletedat IS NULL
  WHERE u.deletedat IS NULL
  GROUP BY u.userid
)
-- –û–±'—î–¥–Ω–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
SELECT
  ur.userid,
  ur.username,
  ur.email,
  ur.rating_count,
  urv.review_count,
  ROUND(CAST(ur.avg_score AS numeric), 2) as avg_score
FROM user_ratings ur
INNER JOIN user_reviews urv ON ur.userid = urv.userid
WHERE ur.rating_count >= 2  -- –§—ñ–ª—å—Ç—Ä: –º—ñ–Ω—ñ–º—É–º 2 –æ—Ü—ñ–Ω–∫–∏
HAVING ROUND(CAST(ur.avg_score AS numeric), 2) > 3.0  -- –°–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª > 3.0
ORDER BY ur.rating_count DESC, ur.avg_score DESC
LIMIT 20;
```

**–©–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**

‚úÖ **CTE (Common Table Expressions):**

- `WITH user_ratings AS (...)` - –ø–µ—Ä—à–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç
- `WITH user_reviews AS (...)` - –¥—Ä—É–≥–∏–π –ø—ñ–¥–∑–∞–ø–∏—Ç
- –†–æ–±–∏—Ç—å –∫–æ–¥ —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–º —Ç–∞ –º–æ–¥—É–ª—å–Ω–∏–º

‚úÖ **–ê–≥—Ä–µ–≥–∞—Ç–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:**

- `COUNT(DISTINCT ...)` - –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
- `AVG(...)` - —Å–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
- `ROUND(...)` - –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ 2 –∑–Ω–∞–∫—ñ–≤

‚úÖ **GROUP BY:**

- –ì—Ä—É–ø—É–≤–∞–Ω–Ω—è –∑–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
- –î–æ–∑–≤–æ–ª—è—î –∞–≥—Ä–µ–≥—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –ø–æ –≥—Ä—É–ø–∞—Ö

‚úÖ **HAVING:**

- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó
- –ó–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è GROUP BY

‚úÖ **JOIN:**

- –û–±'—î–¥–Ω–∞–Ω–Ω—è –¥–≤–æ—Ö CTE
- –ö–æ–º–±—ñ–Ω—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª

### 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–Ω–∏–≥–∞—Ö

**–ë—ñ–∑–Ω–µ—Å-–ø–∏—Ç–∞–Ω–Ω—è:**
_"–Ø–∫—ñ –∫–Ω–∏–≥–∏ –Ω–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à—ñ? –°–∫—ñ–ª—å–∫–∏ –æ—Ü—ñ–Ω–æ–∫ —Ç–∞ –≤—ñ–¥–≥—É–∫—ñ–≤ –≤–æ–Ω–∏ –æ—Ç—Ä–∏–º–∞–ª–∏? –Ø–∫–∏–π —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥?"_

**Endpoint:** `GET /api/analytics/books-stats`

```sql
SELECT
  b.bookid,
  b.title,
  COUNT(DISTINCT r.ratingid) as rating_count,
  ROUND(AVG(r.score), 2) as avg_rating,
  COUNT(DISTINCT rv.reviewid) as review_count,
  COUNT(DISTINCT ba.authorid) as author_count
FROM book b
LEFT JOIN rating r
  ON b.bookid = r.bookid
  AND r.deletedat IS NULL
LEFT JOIN review rv
  ON b.bookid = rv.bookid
  AND rv.deletedat IS NULL
LEFT JOIN bookauthor ba
  ON b.bookid = ba.bookid
WHERE b.deletedat IS NULL
GROUP BY b.bookid, b.title
ORDER BY avg_rating DESC, rating_count DESC
LIMIT 30;
```

**–©–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**

‚úÖ **–ú–Ω–æ–∂–∏–Ω–Ω—ñ JOIN:**

- 3 LEFT JOIN –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –∫–Ω–∏–≥ (–Ω–∞–≤—ñ—Ç—å –±–µ–∑ —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤)

‚úÖ **–ê–≥—Ä–µ–≥–∞—Ü—ñ—è –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª:**

- –†–µ–π—Ç–∏–Ω–≥–∏ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å, —Å–µ—Ä–µ–¥–Ω—î)
- –í—ñ–¥–≥—É–∫–∏ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)
- –ê–≤—Ç–æ—Ä–∏ (–∫—ñ–ª—å–∫—ñ—Å—Ç—å)

‚úÖ **–°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –¥–≤–æ–º–∞ –ø–æ–ª—è–º–∏:**

- –°–ø–æ—á–∞—Ç–∫—É –∑–∞ —Å–µ—Ä–µ–¥–Ω—ñ–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º
- –ü–æ—Ç—ñ–º –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é –æ—Ü—ñ–Ω–æ–∫

### –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥: –¢–æ–ø-5 –∫–Ω–∏–≥ –ø–æ –∂–∞–Ω—Ä–∞—Ö

```sql
WITH book_stats AS (
  SELECT
    b.bookid,
    b.title,
    g.name as genre_name,
    COUNT(DISTINCT r.ratingid) as rating_count,
    AVG(r.score) as avg_score,
    ROW_NUMBER() OVER (
      PARTITION BY g.genreid
      ORDER BY AVG(r.score) DESC, COUNT(DISTINCT r.ratingid) DESC
    ) as rank_in_genre
  FROM book b
  INNER JOIN bookgenre bg ON b.bookid = bg.bookid
  INNER JOIN genre g ON bg.genreid = g.genreid
  LEFT JOIN rating r
    ON b.bookid = r.bookid
    AND r.deletedat IS NULL
  WHERE b.deletedat IS NULL
  GROUP BY b.bookid, b.title, g.genreid, g.name
)
SELECT
  genre_name,
  title,
  rating_count,
  ROUND(avg_score, 2) as avg_score,
  rank_in_genre
FROM book_stats
WHERE rank_in_genre <= 5
ORDER BY genre_name, rank_in_genre;
```

**–©–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**

‚úÖ **–í—ñ–∫–æ–Ω–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (Window Functions):**

- `ROW_NUMBER() OVER (...)` - –Ω—É–º–µ—Ä–∞—Ü—ñ—è –≤ –º–µ–∂–∞—Ö –≥—Ä—É–ø–∏
- `PARTITION BY` - —Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ –≥—Ä—É–ø–∏ (–ø–æ –∂–∞–Ω—Ä–∞—Ö)
- `ORDER BY` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ–∫–Ω–∞ - —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –≤ –º–µ–∂–∞—Ö –≥—Ä—É–ø–∏

‚úÖ **CTE –∑ –≤—ñ–∫–æ–Ω–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é:**

- –°–ø–æ—á–∞—Ç–∫—É –æ–±—á–∏—Å–ª—é—î–º–æ —Ä–∞–Ω–≥
- –ü–æ—Ç—ñ–º —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç–æ–ø-5

---

## –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—ñ–¥—Ö–æ–¥—ñ–≤

### –ü—ñ–¥–∑–∞–ø–∏—Ç–∏ vs CTE

**–ü—ñ–¥–∑–∞–ø–∏—Ç:**

```sql
SELECT * FROM (
  SELECT userid, COUNT(*) as cnt
  FROM rating
  GROUP BY userid
) AS subquery
WHERE cnt > 5;
```

**CTE (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ):**

```sql
WITH user_counts AS (
  SELECT userid, COUNT(*) as cnt
  FROM rating
  GROUP BY userid
)
SELECT * FROM user_counts
WHERE cnt > 5;
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ CTE:**

- –ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–µ
- –ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤
- –õ–µ–≥—à–µ –¥–µ–±–∞–∂–∏—Ç–∏
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ä–µ–∫—É—Ä—Å—ñ—ó

### JOIN vs EXISTS

**JOIN:**

```sql
SELECT DISTINCT u.*
FROM users u
INNER JOIN rating r ON u.userid = r.userid
WHERE r.score > 4.0;
```

**EXISTS:**

```sql
SELECT u.*
FROM users u
WHERE EXISTS (
  SELECT 1 FROM rating r
  WHERE r.userid = u.userid
    AND r.score > 4.0
);
```

**–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ EXISTS:**

- –ö–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è
- –ö–æ–ª–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ –∑ –¥—Ä—É–≥–æ—ó —Ç–∞–±–ª–∏—Ü—ñ
- –ó–∞–∑–≤–∏—á–∞–π —à–≤–∏–¥—à–µ –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Ç–∞–±–ª–∏—Ü—å
